name: Deploy Web

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-web
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: "24"

      - run: bun install

      # Build both packages (turbo handles dependency ordering)
      - name: Build console & docs
        run: bun turbo build --filter="./packages/console/app" --filter="./packages/web"

      # Merge docs static pages into console public assets
      - name: Merge docs into console
        run: cp -r packages/web/dist/docs packages/console/app/.output/public/docs

      # Deploy single Cloudflare Worker â†’ opensploit.ai
      # Serves: / (home), /docs/* (static docs), /registry.* (proxy)
      - name: Deploy
        working-directory: packages/console/app
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          rm -rf .wrangler
          cd .output/server
          node -e "
            const fs = require('fs');
            const cfg = JSON.parse(fs.readFileSync('wrangler.json', 'utf8'));
            cfg.name = 'opensploit-console';
            cfg.compatibility_date = cfg.compatibility_date || '2024-09-19';
            cfg.routes = [{ pattern: 'opensploit.ai', custom_domain: true }];
            fs.writeFileSync('wrangler.json', JSON.stringify(cfg, null, 2));
          "
          npx wrangler@latest deploy
